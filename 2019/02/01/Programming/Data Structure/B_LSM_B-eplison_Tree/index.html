<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Data Structures for DB(External Disk) | B Tree, LSM Tree | Daemon.D.Blog</title><meta name="author" content="DaemondShu"><meta name="copyright" content="DaemondShu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文将探讨当存储介质是外部存储，比如磁盘、闪存时，有哪些主流的存储数据结构(传统的二叉树将不再适用)。 本文以key-value数据库为例讲述不同数据结构的差异。其KV存储包含以下5个基本操作  get(K) 查找key K对应的value put(K,V) 插入键值对（K，V） update(K,V) 查找key K对应的value更新为V delete(K) 删除key K对应的条目 scan"><meta property="og:type" content="article"><meta property="og:title" content="Data Structures for DB(External Disk) | B Tree, LSM Tree"><meta property="og:url" content="http://daemondshu.github.io/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/index.html"><meta property="og:site_name" content="Daemon.D.Blog"><meta property="og:description" content="本文将探讨当存储介质是外部存储，比如磁盘、闪存时，有哪些主流的存储数据结构(传统的二叉树将不再适用)。 本文以key-value数据库为例讲述不同数据结构的差异。其KV存储包含以下5个基本操作  get(K) 查找key K对应的value put(K,V) 插入键值对（K，V） update(K,V) 查找key K对应的value更新为V delete(K) 删除key K对应的条目 scan"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://daemondshu.github.io/images/bg/next_size.png"><meta property="article:published_time" content="2019-01-31T16:00:00.000Z"><meta property="article:modified_time" content="2019-01-31T16:00:00.000Z"><meta property="article:author" content="DaemondShu"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://daemondshu.github.io/images/bg/next_size.png"><link rel="shortcut icon" href="/images/logo/favicon-32x32.png"><link rel="canonical" href="http://daemondshu.github.io/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: DaemondShu","link":"Link: ","source":"Source: Daemon.D.Blog","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Data Structures for DB(External Disk) | B Tree, LSM Tree",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2019-02-01 00:00:00"}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/butterfly_common.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/user_256px.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">12</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Daemon.D.Blog"><span class="site-name">Daemon.D.Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Data Structures for DB(External Disk) | B Tree, LSM Tree</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2019-01-31T16:00:00.000Z" title="Created 2019-02-01 00:00:00">2019-02-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2019-01-31T16:00:00.000Z" title="Updated 2019-02-01 00:00:00">2019-02-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Programming/">Programming</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Programming/Data-Structure/">Data Structure</a></span></div><div class="meta-secondline"></div></div></div><article class="post-content" id="article-container"><p>本文将探讨当存储介质是外部存储，比如磁盘、闪存时，有哪些主流的存储数据结构(传统的二叉树将不再适用)。 本文以key-value数据库为例讲述不同数据结构的差异。<br>其KV存储包含以下5个基本操作</p><ul><li>get(K) 查找key K对应的value</li><li>put(K,V) 插入键值对（K，V）</li><li>update(K,V) 查找key K对应的value更新为V</li><li>delete(K) 删除key K对应的条目</li><li>scan(K1,K2) 得到从K1到K2的所有key和value</li></ul><h1 id="B-系列"><a href="#B-系列" class="headerlink" title="B 系列"></a>B 系列</h1><h2 id="B-B-Tree"><a href="#B-B-Tree" class="headerlink" title="B ( B- ) Tree"></a>B ( B- ) Tree</h2><p>B树也称B-树,它是一颗多路平衡查找树。我们描述一颗B树时需要指定它的阶数，阶数表示了一个结点最多有多少个孩子结点，一般用字母m表示阶数。当m取2时，就是我们常见的二叉搜索树。</p><blockquote><p>应用的数据库 MongoDB</p></blockquote><h3 id="结构图示"><a href="#结构图示" class="headerlink" title="结构图示"></a>结构图示</h3><p>以一颗阶数为4的为例，图中数字对应key，data对应value<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/B_structure.png" loading="lazy"></p><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><ol><li>每个结点最多有m-1个key。</li><li>根结点最少可以只有1个key。</li><li>非根结点至少有$⌈m&#x2F;2⌉-1$个key。（最差节点利用率为50%）</li><li>每个结点中的关键字都按照顺序排列，每个关键字的左子树中的所有关键字都小于它，而右子树中的所有关键字都大于它。</li><li>所有叶子结点都位于同一层，或者说根结点到每个叶子结点的长度都相同。</li><li>设某个节点含有n个元素，则<ul><li>如果是叶子节点，该节点含有n个value</li><li>如果是非叶子节点，该节点不仅含有n个value，还存有n+1个子节点的地址（边）</li></ul></li></ol><h3 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h3><p>即根据一个key，得到对应的value(data)，也可能找不到。</p><h4 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h4><p>其步骤如下：</p><ol><li>从根节点开始</li><li>在当前节点内通过二分查找定位到一个最小且&gt;&#x3D;key的key</li><li>如果key已经命中（相等），则返回该key的值。 如果没有命中，则加载新的子节点，返回第二步继续查找（如果已经是叶子节点，就可以返回不存在）。</li></ol><h4 id="复杂度"><a href="#复杂度" class="headerlink" title="复杂度"></a>复杂度</h4><p>整个过程时间复杂度是 O(logMlogN),</p><ul><li>M是阶数， logM对应在节点内做二分查找，每次加载节点都要二分查找一次。</li><li>N是元素个数， logN对应加载节点的次数，即树的深度</li></ul><h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><p>另外更新就是先查找，然后修改value。就不做多的赘述了。不会修改树的结构，但是可能会导致节点地址改动（比如当将一个很小的value替换成一个很大的value，原始节点的物理空间不够，就需要重新将这个节点写入其他地方）。</p><h3 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h3><p>插入就是查找定位到节点后，在指定位置插入。比较复杂的部分是当节点存在节点满了之后就需要分裂。</p><p>最开始插入会先插入到叶子节点。若满则以中值为划分分裂成两个，同时将中值加入到父节点中。如果父节点又满，则进行相同操作。直到分裂向上的节点中没有满。</p><h4 id="图示"><a href="#图示" class="headerlink" title="图示"></a>图示</h4><p>我们以图例来理解这个过程，</p><ol><li>初始： 存在一棵M为5的树,即最大元素个数是4。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/B_insert.png" loading="lazy"></li><li>插入成功，但是导致一个叶子节点满<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/B_insert_2.png" loading="lazy"></li><li>按中值(27)分裂，并将中值插入到父亲节点<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/B_insert_3.png" loading="lazy"></li><li>因为父亲节点满，继续分裂。因为是根节点，所以向上过程直接添加一个新的根节点。整个插入结束。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/b_insert_4.png" loading="lazy"></li></ol><h4 id="复杂度-1"><a href="#复杂度-1" class="headerlink" title="复杂度"></a>复杂度</h4><p>O(logNlogM + M )</p><ul><li>logNlogM : 访问代价</li><li>M : 插入造成的移位或者分裂</li></ul><h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>删除过程相对复杂。 但是其基本原则是，当节点删除一个元素时，<br>优先从子节点找后继替代自己，如果做不到，就从兄弟节点找（完成一个兄弟到父亲，父亲到自己的转移。若兄弟也做不到，则和兄弟进行合并。（因为此时两个字节点个数都是$⌈m&#x2F;2⌉-1$）</p><h4 id="不同情况图示"><a href="#不同情况图示" class="headerlink" title="不同情况图示"></a>不同情况图示</h4><ol><li><p>初始，阶数为5，即一个节点最少2个元素<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/b_delete_0.png" loading="lazy"></p></li><li><p>删除21，正常删除，因为删除后节点个数仍然&gt;2<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/b_delete2.png" loading="lazy"></p></li><li><p>删除27，在非叶子节点,从子节点替换，</p><ol><li>这里默认优先从右子节点替换 (试探法，减少读取次数，因为大概率情况下不需要转移)<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/b_delete_3.png" loading="lazy"></li><li>但是子节点不够，就需要从兄弟节点移动过来。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/b_delete_4.png" loading="lazy"></li></ol></li><li><p>删除32</p></li><li><p>叶子节点个数不够，但是兄弟节点也无法转移<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/b_delete5.png" loading="lazy"></p></li><li><p>合并两个兄弟节点元素和兄弟之间的元素<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/b_delete_6.png" loading="lazy"></p></li></ol><h4 id="复杂度-2"><a href="#复杂度-2" class="headerlink" title="复杂度"></a>复杂度</h4><p>O(logNlogM + M)</p><ul><li>logNlogM : 访问代价</li><li>M : 删除造成的移位或者合并</li></ul><h2 id="B-Tree"><a href="#B-Tree" class="headerlink" title="B+ Tree"></a>B+ Tree</h2><p>相比于b树，区别在于</p><ol><li>非叶子节点是索引节点，只存储部分key和子节点地址，不存储value</li><li>所有key和value都会存储在叶子节点中</li><li>叶子节点之间存在顺序指向</li></ol><p>查找和更新和B树类似，就不提了。插入和删除思想一致，但是略有差别。</p><blockquote><p>应用的数据库 MySQL 的 innodb</p></blockquote><h3 id="结构图示-1"><a href="#结构图示-1" class="headerlink" title="结构图示"></a>结构图示</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/b+_structure.png" loading="lazy"></p><h3 id="插入-1"><a href="#插入-1" class="headerlink" title="插入"></a>插入</h3><p>插入思想不变。即数据插入到叶子节点，如果满，则分裂，将中值插入到父亲节点，直至某个节点不满。</p><ol><li>如初始<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/B+_insert_0.png" loading="lazy"></li><li>插入18,叶子满，分裂，中值插入到父亲节点<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/b+_insert_1.png" loading="lazy"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/b+_insert_2.png" loading="lazy"></li></ol><h3 id="删除-1"><a href="#删除-1" class="headerlink" title="删除"></a>删除</h3><p>必须删除叶子节点上的元素，同时更新索引节点上的。由于父亲节点不存在记录，所以都是从从兄弟之间转移。 当无法转移的时候合并节点。</p><ol><li>如初始<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/B+_delete0.png" loading="lazy"></li><li>删除7<ol><li>删除后发现不足，但是兄弟节点也无法转移<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/B+_delete01.png" loading="lazy"></li><li>叶子合并<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/b+_delete1.png" loading="lazy"></li><li>索引节点合并<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/B+_delete2.png" loading="lazy"></li></ol></li></ol><h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul><li>快速查找</li><li>B+：<ul><li>对scan(range query，范围扫描 顺序访问)更加友好</li><li>索引节点内单个页存储元素个数可以更多，降低树的深度，尤其适合value较大的场景</li></ul></li><li>B： 查找更加快（不需要每次访问到子节点）</li><li>value热更新开销小</li></ul><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul><li>插入操作慢，写</li><li>空间放大率高（空间利用率不高）， 数据结构变更容易产生文件空洞</li><li>不同节点随机存储在磁盘上，会产生大量的随机IO。</li></ul><h1 id="LSM-Tree"><a href="#LSM-Tree" class="headerlink" title="LSM Tree"></a>LSM Tree</h1><p>将日志文件系统与树形数据结构结合适用的形式，提出一种延迟更新、批量写入硬盘的LSM-tree及其算法，</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><ul><li>C0树（常驻内存）</li><li>C1-N 树(位于磁盘)<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/lsm_tree_structure.png" loading="lazy"></li></ul><h2 id="插入、更新、删除"><a href="#插入、更新、删除" class="headerlink" title="插入、更新、删除"></a>插入、更新、删除</h2><p>就是将新的键值对放入C0即算插入完成，通过compaction操作去异步维护C0-N之间的关系。</p><ol><li>待C0存储的内容大于一个阈值，就会将内容全部合并到C1中，然后清空C0</li><li>对于C1-N也同理，任何一个Ci查过其阈值后，就讲内容合并到Ci+1</li></ol><h2 id="查找-1"><a href="#查找-1" class="headerlink" title="查找"></a>查找</h2><p>由于compaction导致同一个key可能存在多层中，但是越上层的数据越新。<br>所以查找则变成从上至下的查询。过程如下</p><ol><li><code>i = 0</code> (从C0开始)</li><li>如果在Ci中找到了K，则返回value，否则<code>i++</code>然后回到第1步，</li></ol><h2 id="特性-1"><a href="#特性-1" class="headerlink" title="特性"></a>特性</h2><h3 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h3><ul><li>大幅度提高插入（修改、删除）性能</li><li>空间放大率降低</li><li>访问新数据更快，适合时序、实时存储</li><li>数据热度分布和level相关</li></ul><h3 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h3><ul><li>牺牲了读性能（一次可能访问多个层）</li><li>读、写放大率提升</li></ul><h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><p>LSM Tree对于C树的具体实现很多，理论上Ci树可以是任何允许索引的结构，比如B、hash、二叉树等结构，但是目前业界主流实现可以参考LevelDB和RocksDB。</p><h1 id="Bepsilon-ε-Tree-x2F-Fractal-Tree"><a href="#Bepsilon-ε-Tree-x2F-Fractal-Tree" class="headerlink" title="Bepsilon(ε) Tree &#x2F; Fractal Tree"></a>Bepsilon(ε) Tree &#x2F; Fractal Tree</h1><p>一个针对B树做写优化的结构。 可以看做是LSM树和B树的结合</p><h2 id="对应系统"><a href="#对应系统" class="headerlink" title="对应系统"></a>对应系统</h2><p>被TokuDB 和 the BetrFS 采用。<br>为了防止歧义，我也将论文中的原文粘贴在引用中。</p><h2 id="结构-1"><a href="#结构-1" class="headerlink" title="结构"></a>结构</h2><ul><li>每个node内置一个buffer，这个buffer是持久化存储的。</li><li>一个节点的大小为B， 那么存储原始数据的pivots部分大小为<code>Bε</code>和buffer部分大小为<code>B-Bε</code>, ε是0-1之间的一个数<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/Be_structure.png" loading="lazy"><blockquote><p>The distinguishing feature of a Bε-tree is that in- ternal nodes also allocate some space for a buffer, as shown in Figure 1. The buffer in each internal node is used to store messages, which encode updates that will eventually be applied to leaves under this node. This buffer is not an in-memory data structure; it is part of the node and is written to disk, evicted from memory, etc., whenever the node is. The value of ε, which must be between 0 and 1, is a tuning parameter that selects how much space internal nodes use for pivots (≈ Bε) and how much space is used as a buffer (≈ B − Bε).</p></blockquote></li></ul><h2 id="写操作-（插入和删除）"><a href="#写操作-（插入和删除）" class="headerlink" title="写操作 （插入和删除）"></a>写操作 （插入和删除）</h2><ol><li>每个写操作和删除操作都会编码成<code>message</code>，每个buffer中的message会以二叉搜索树的方式组织（比如红黑树），</li><li>每次都是先写入root node的buffer</li><li>当一个节点的buffer满时，消息将会批量地写给一个子节点</li><li>最终buffer会传递到叶子节点，当叶子节点buffer满时，将改动应用到叶子节点，然后分裂或者合并node的过程就跟B树一样了</li></ol><blockquote><p>Insertions are encoded as “insert messages”, addressed to a particular key, and added to the buffer of the root node of the tree. When enough messages have been added to a node to fill the node’s buffer, a batch of messages are flushed to one of the node’s children. Generally, the child with the most pending messages is selected. Over the course of flushing, each message is ultimately delivered to the appropriate leaf node, and the new key and value are added to the leaf. When a leaf node becomes too full, it splits, just as in a B-tree. Similar to a B-tree, when an interior node gets too many children, it splits and the messages in its buffer are distributed between the two new nodes.</p></blockquote><h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><p>从root到leaf先查询buffer，<br>buffer中没有再去leafnode里查看。 查询路径和B树相同。</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nullzx/p/8729425.html">B树和B+树的插入、删除图文详解</a></li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/siegfang/archive/2013/01/12/lsm-tree.html">日志结构的合并树 The Log-Structured Merge-Tree</a></li><li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/news/340271">LSM-tree 基本原理及应用</a></li><li><a target="_blank" rel="noopener" href="https://akumuli.org/akumuli/2017/08/01/storage-engine-design2/">Storage engine design(Part2)</a></li><li><a target="_blank" rel="noopener" href="http://www3.cs.stonybrook.edu/~rob/papers/login15.pdf">An Introduction to Bε trees and Write-Optimization</a></li><li><a target="_blank" rel="noopener" href="http://kernelmaker.github.io/Btree_LSM_FTI">B+ Tree、LSM、Fractal tree index 读写放大分析</a></li><li><a target="_blank" rel="noopener" href="http://blog.omega-prime.co.uk/2016/07/05/datastructures-for-external-memory/">Data structures for external memory</a></li><li><a target="_blank" rel="noopener" href="https://www.open-open.com/lib/view/open1420338434078.html">IndexFS: Scaling File System Metadata Performance</a></li><li><a target="_blank" rel="noopener" href="http://openinx.github.io/2015/11/25/ft-index-implement/">TokuDB的索引结构–分形树的实现</a></li><li><a target="_blank" rel="noopener" href="http://mysql.taobao.org/monthly/2017/07/04/">TokuDB · 引擎特性 · HybridDB for MySQL高压缩引擎TokuDB 揭秘</a></li><li><a target="_blank" rel="noopener" href="https://www.biaodianfu.com/tokudb.html">MySQL 高性能存储引擎：TokuDB初探</a></li></ul></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://daemondshu.github.io">DaemondShu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://daemondshu.github.io/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/">http://daemondshu.github.io/2019/02/01/Programming/Data%20Structure/B_LSM_B-eplison_Tree/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/images/bg/next_size.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/03/21/Storage/data_crash_recovery/" title="基于日志的崩溃后的数据恢复 | redo, undo log"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/bg/next_size.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">基于日志的崩溃后的数据恢复 | redo, undo log</div></div></a></div><div class="next-post pull-right"><a href="/2019/01/20/System%20Design/Linux/OS_basic/" title="OS Basic"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/bg/next_size.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">OS Basic</div></div></a></div></nav><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/user_256px.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">DaemondShu</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">12</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#B-%E7%B3%BB%E5%88%97"><span class="toc-number">1.</span> <span class="toc-text">B 系列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#B-B-Tree"><span class="toc-number">1.1.</span> <span class="toc-text">B ( B- ) Tree</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%9B%BE%E7%A4%BA"><span class="toc-number">1.1.1.</span> <span class="toc-text">结构图示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-number">1.1.2.</span> <span class="toc-text">定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE"><span class="toc-number">1.1.3.</span> <span class="toc-text">查找</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">复杂度</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0"><span class="toc-number">1.1.4.</span> <span class="toc-text">更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%92%E5%85%A5"><span class="toc-number">1.1.5.</span> <span class="toc-text">插入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%BE%E7%A4%BA"><span class="toc-number">1.1.5.1.</span> <span class="toc-text">图示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E5%BA%A6-1"><span class="toc-number">1.1.5.2.</span> <span class="toc-text">复杂度</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4"><span class="toc-number">1.1.6.</span> <span class="toc-text">删除</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E6%83%85%E5%86%B5%E5%9B%BE%E7%A4%BA"><span class="toc-number">1.1.6.1.</span> <span class="toc-text">不同情况图示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E5%BA%A6-2"><span class="toc-number">1.1.6.2.</span> <span class="toc-text">复杂度</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#B-Tree"><span class="toc-number">1.2.</span> <span class="toc-text">B+ Tree</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%9B%BE%E7%A4%BA-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">结构图示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%92%E5%85%A5-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">插入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4-1"><span class="toc-number">1.2.3.</span> <span class="toc-text">删除</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%80%A7"><span class="toc-number">1.3.</span> <span class="toc-text">特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E7%82%B9"><span class="toc-number">1.3.1.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9"><span class="toc-number">1.3.2.</span> <span class="toc-text">缺点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LSM-Tree"><span class="toc-number">2.</span> <span class="toc-text">LSM Tree</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%84"><span class="toc-number">2.1.</span> <span class="toc-text">结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E3%80%81%E6%9B%B4%E6%96%B0%E3%80%81%E5%88%A0%E9%99%A4"><span class="toc-number">2.2.</span> <span class="toc-text">插入、更新、删除</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE-1"><span class="toc-number">2.3.</span> <span class="toc-text">查找</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%80%A7-1"><span class="toc-number">2.4.</span> <span class="toc-text">特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E7%82%B9-1"><span class="toc-number">2.4.1.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9-1"><span class="toc-number">2.4.2.</span> <span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.5.</span> <span class="toc-text">具体实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Bepsilon-%CE%B5-Tree-x2F-Fractal-Tree"><span class="toc-number">3.</span> <span class="toc-text">Bepsilon(ε) Tree &#x2F; Fractal Tree</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E7%B3%BB%E7%BB%9F"><span class="toc-number">3.1.</span> <span class="toc-text">对应系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%84-1"><span class="toc-number">3.2.</span> <span class="toc-text">结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E6%93%8D%E4%BD%9C-%EF%BC%88%E6%8F%92%E5%85%A5%E5%92%8C%E5%88%A0%E9%99%A4%EF%BC%89"><span class="toc-number">3.3.</span> <span class="toc-text">写操作 （插入和删除）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.4.</span> <span class="toc-text">查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">3.5.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/10/16/System%20Design/Distributed%20System/consistency_model/" title="Consistency Model Summary in Distributed System">Consistency Model Summary in Distributed System</a><time datetime="2022-10-15T16:00:00.000Z" title="Updated 2022-10-16 00:00:00">2022-10-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/05/21/Programming/Java/ModernGC/" title="JVM GC(2) | Modern Garbage Collectors - CMS, G1, ZGC, Shenandoah GC">JVM GC(2) | Modern Garbage Collectors - CMS, G1, ZGC, Shenandoah GC</a><time datetime="2022-05-20T16:00:00.000Z" title="Updated 2022-05-21 00:00:00">2022-05-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/02/20/System%20Design/Distributed%20System/cache_overview/" title="Get Started with Cache">Get Started with Cache</a><time datetime="2022-02-19T16:00:00.000Z" title="Updated 2022-02-20 00:00:00">2022-02-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/08/20/System%20Design/Distributed%20System/distributed_transcation/" title="Distributed Transaction - 2PC, 3PC">Distributed Transaction - 2PC, 3PC</a><time datetime="2021-08-19T16:00:00.000Z" title="Updated 2021-08-20 00:00:00">2021-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/04/05/Storage/Database/Database_Transaction/" title="Database Transaction - ACID &amp; Isolation Level">Database Transaction - ACID &amp; Isolation Level</a><time datetime="2021-06-09T16:00:00.000Z" title="Updated 2021-06-10 00:00:00">2021-06-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2016 - 2023 By DaemondShu</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(()=>{
  const getGiscusTheme = theme => {
    return theme === 'dark' ? 'dark' : 'light'
  }

  const loadGiscus = () => {
    const config = Object.assign({
      src: 'https://giscus.app/client.js',
      'data-repo': 'DaemondShu/DaemondShu.github.io',
      'data-repo-id': 'MDEwOlJlcG9zaXRvcnkxNzYxMjUzNDI=',
      'data-category-id': 'DIC_kwDOCn91ns4CTWjW',
      'data-mapping': 'pathname',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true
    },null)

    const ele = document.createElement('script')
    for (let key in config) {
      ele.setAttribute(key, config[key])
    }
    document.getElementById('giscus-wrap').appendChild(ele)
  }

  const changeGiscusTheme = theme => {
    const sendMessage = message => {
      const iframe = document.querySelector('iframe.giscus-frame')
      if (!iframe) return
      iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app')
    }

    sendMessage({
      setConfig: {
        theme: getGiscusTheme(theme)
      }
    });
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if ('Giscus' === 'Giscus' || !true) {
    if (true) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment= loadGiscus
  }
})()</script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>